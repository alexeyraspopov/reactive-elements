<!-- todo: class binding -->
<!-- todo: two-way binding -->
<!-- todo: events -->
<template>
	<style type="text/css">
		span{ color: blue; }
	</style>

	<span data-key="greetPerson">Hello, <!-- mapped --></span>
</template>

<script src="data.js"></script>
<script src="walk.js"></script>
<script src="fastdom.js"></script>
<script>
	var Element = Object.create(HTMLElement.prototype);

	var elementDoc = document.currentScript.ownerDocument;

	var template = elementDoc.querySelector('template').content;

	Element.createdCallback = function(){
		var shadow = this.createShadowRoot();

		var content = document.importNode(template, true);

		shadow.appendChild(content);

		this.vm = Object.keys(this.dataset).reduce(function(vm, key){
			vm[key] = window.observable(this.dataset[key]);
			return vm;
		}.bind(this), {});

		this.vm.mapped = this.vm.greetPerson.map(function(value){
			return value + '_mapped';
		});
	};

	Element.attachedCallback = function(){
		var root = this.shadowRoot,
			vm = this.vm;

		window.walk(root, function(node, next){
			if(node instanceof HTMLElement && node !== root){
				Object.keys(node.dataset).forEach(function(attr){
					var model = node.dataset[attr];

					vm[model].bind(function(value){
						fastdom.write(function(){
							node.setAttribute(attr, value)
						})
					});
				});
			}

			if(node instanceof Comment){
				var key = node.textContent.trim();
				var text = document.createTextNode('');

				vm[key].bind(function(value){
					fastdom.write(function(){
						text.textContent = value;
					});
				});

				fastdom.write(function(){
					node.parentNode.insertBefore(text, node);
					node.parentNode.removeChild(node);
				});
			}

			next();
		}, { whatToShow: NodeFilter.SHOW_ELEMENT + NodeFilter.SHOW_COMMENT });
	};

	Element.detachedCallback = function(){
		// destroy all this shit
	};

	Element.attributeChangedCallback = function(attr, oldValue, newValue){
		if(/^data-/.test(attr)){
			this.vm[attr.split('-').slice(1).join('-').replace(/\-(.)/g, function(_, letter){
				return letter.toUpperCase();
			})](newValue);
		}
	};

	window.XHello = document.registerElement('x-hello', { prototype: Element });
</script>